<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>parser-slip-encoder/slip-encoder.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ByteLengthParser.html">ByteLengthParser</a></li><li><a href="CCTalkParser.html">CCTalkParser</a></li><li><a href="DelimiterParser.html">DelimiterParser</a></li><li><a href="ReadLineParser.html">ReadLineParser</a></li><li><a href="ReadyParser.html">ReadyParser</a></li><li><a href="RegexParser.html">RegexParser</a></li><li><a href="SlipEncoderParser.html">SlipEncoderParser</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">parser-slip-encoder/slip-encoder.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'
const Buffer = require('safe-buffer').Buffer
const Transform = require('stream').Transform

const END = 0xC0;
const ESC = 0xDB;
const ESC_END = 0xDC;
const ESC_ESC = 0xDD;

/**
* A transform stream that emits SLIP-encoded data for each incoming packet.
* @extends Transform
* @summary Runs in O(n) time, adding a 0xC0 character at the end of each
* received packet and escaping characters, according to RFC 1055. Adds another
* 0xC0 character at the beginning if the `bluetoothQuirk` option is truthy (as
* per the Bluetooth Core Specification 4.0, Volume 4, Part D, Chapter 3 "SLIP Layer").
* Runs in O(n) time.
* @example
// Read lines from a text file, then SLIP-encode each and send them to a serial port
const SerialPort = require('serialport')
const SlipEncoder = require('@serialport/parser-slip-encoder')
const Readline = require('parser-readline')
const fileReader = require('fs').createReadStream('/tmp/some-file.txt');
const port = new SerialPort('/dev/tty-usbserial1')
const lineParser = fileReader.pipe(new Readline({ delimiter: '\r\n' }));
const encoder = fileReader.pipe(new SlipEncoder({ bluetoothQuirk: false }));
encoder.pipe(port);
*/
class SlipEncoderParser extends Transform {
	constructor (options) {
		options = options || {}
		super(options)

		if (options.bluetoothQuirk) {
			this._bluetoothQuirk = true;
		}
	}

	_transform (chunk, encoding, cb) {
		const chunkLength = chunk.length;

		if (this._bluetoothQuirk &amp;&amp; chunkLength === 0) {
			// Edge case: push no data. Bluetooth-quirky SLIP parsers don't like
			// lots of 0xC0s together.
			return cb();
		}

		// Allocate memory for the worst-case scenario: all bytes are escaped,
		// plus start and end separators.
		let encoded = Buffer.alloc((chunkLength * 2) + 2);
		let j = 0;

		if (this._bluetoothQuirk) {
			encoded[j++] = END;
		}

		for (let i=0; i&lt;chunkLength; i++) {
			let byte = chunk[i];
			if (byte === END) {
				encoded[j++] = ESC;
				byte = ESC_END;
			} else if (byte === ESC) {
				encoded[j++] = ESC;
				byte = ESC_ESC;
			}

			encoded[j++] = byte;
		}

		encoded[j++] = END;

		cb(null, encoded.slice(0, j));
	}
}

module.exports = SlipEncoderParser
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Jun 23 2018 21:24:37 GMT-0400 (EDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
